/* Программа для отображения информации о адресах в процессе */
/* Адаптировано из Gray, J., program 1.4 */
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/types.h>
#include <unistd.h>

/* Ниже приведено определение макроса */
#define SHW_ADR(ID, I) (printf("Идентификатор %s \t находится по виртуальному адресу: %8X\n", ID, &I))

// Объявление внешних переменных, определенных компоновщиком (линкером)
// Эти переменные указывают на границы сегментов памяти процесса
extern int etext, edata, end; /* Глобальные переменные для памяти процесса */

char *cptr = "Это сообщение выводится функцией showit()\n"; /* Статическая переменная */
char buffer1[25]; // Статический массив
int showit(); /* Прототип функции */

int main() {
  int i = 0; /* Автоматическая переменная (в стеке) */

  /* Вывод информации о адресах */
  // Вывод адресов границ сегментов памяти
  printf("\nАдрес etext: %8X \n", &etext);  // Конец сегмента кода (текстовый сегмент)
  printf("Адрес edata: %8X \n", &edata);    // Конец сегмента инициализированных данных
  printf("Адрес end  : %8X \n", &end);      // Конец сегмента неинициализированных данных (BSS)

  // Вывод адресов различных объектов в памяти
  SHW_ADR("main", main);      // Адрес функции main (в сегменте кода)
  SHW_ADR("showit", showit);  // Адрес функции showit (в сегменте кода)
  SHW_ADR("cptr", cptr);      // Адрес указателя на строку (в сегменте данных)
  SHW_ADR("buffer1", buffer1); // Адрес статического массива (в сегменте BSS)
  SHW_ADR("i", i);            // Адрес локальной переменной (в стеке)
  
  strcpy(buffer1, "Демонстрация работы\n");   // Копирование строки в буфер
  write(1, buffer1, strlen(buffer1) + 1); // Системный вызов для вывода
  showit(cptr);

  return 0;
} /* конец функции main */

/* Следующая функция */
int showit(char *p) {
  char *buffer2; // Локальная переменная (располагается в стеке)
  SHW_ADR("buffer2", buffer2);
  
  // Выделение памяти в куче (heap)
  if ((buffer2 = (char *)malloc((unsigned)(strlen(p) + 1))) != NULL) {
    printf("Память выделена по адресу %X\n", buffer2);
    strcpy(buffer2, p);    // Копирование строки
    printf("%s", buffer2); // Вывод строки
    free(buffer2);         // Освобождение памяти
  } else {
    printf("Ошибка выделения памяти\n");
    exit(1);
  }
  return 0;
}